<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraia.ai - Sua IA para Decifrar Documentos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Nunito -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f7fafc;
            color: #2D3748;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .primary-green-text { color: #2F855A; }
        .upload-box-border { border-color: #B2F5EA; }
        .upload-box-hover:hover {
            background-color: #f0fdfa;
            border-color: #38A169;
        }
        .btn-primary-green {
            background-color: #2F855A;
            color: white;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary-green:hover:not(:disabled) { background-color: #276749; }
        .btn-primary-green:disabled {
            background-color: #9AE6B4;
            cursor: not-allowed;
        }
        .logo-icon svg {
            width: 32px;
            height: 32px;
            margin-right: 8px;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2D3748;
        }
        .logo-text .ai {
            color: #2F855A;
            font-weight: 700;
        }
        .result-card {
            background-color: white;
            border: 1px solid #E2E8F0;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
        }
        .result-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #F1F5F9;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-label {
            font-weight: 600;
            color: #4A5568;
            width: 160px; /* Largura fixa para os rótulos */
            flex-shrink: 0; /* Impede que o rótulo encolha */
        }
        .result-value {
            color: #1A202C;
            flex-grow: 1;
        }
    </style>
</head>
<body>

    <!-- Cabeçalho -->
    <header class="py-6 px-4 sm:px-6 lg:px-8 w-full">
        <div class="max-w-6xl mx-auto flex items-center">
            <div class="flex items-center logo-icon">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20,10 L80,10 L80,70 L60,90 L40,90 L20,70 Z" fill="#E6FFFA" stroke="#2F855A" stroke-width="3"/>
                    <path d="M30,10 L30,50 M70,10 L70,50" fill="none" stroke="#B2F5EA" stroke-width="2" stroke-dasharray="3,3"/>
                    <path d="M25,60 L75,60" fill="none" stroke="#2F855A" stroke-width="5"/>
                </svg>
                <span class="logo-text">Extraia<span class="ai">.ai</span></span>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="flex-grow flex flex-col items-center justify-center text-center px-4 py-12">
        <div class="max-w-2xl w-full">
            <div id="mainContent">
                <h1 class="text-3xl sm:text-4xl font-bold primary-green-text mb-8">
                    Sua inteligência artificial para decifrar documentos.
                </h1>

                <div id="uploadArea" class="upload-box-border upload-box-hover border-2 dashed rounded-lg p-8 sm:p-12 flex flex-col items-center justify-center cursor-pointer mb-6 min-h-[200px] transition-colors">
                    <svg class="w-16 h-16 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    <p class="text-lg text-gray-600 mb-2">Arraste seu arquivo para cá ou clique para selecionar.</p>
                    <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.txt">
                </div>

                <p class="text-sm text-gray-500 mb-8">
                    Formatos aceitos: PDF, DOCX, DOC, TXT
                </p>

                <button id="extractButton" class="btn-primary-green font-semibold py-3 px-8 rounded-lg text-lg shadow-md" disabled>
                    Extrair Agora!
                </button>
            </div>
            
            <div id="loadingSpinner" class="mt-4 hidden">
                 <svg class="animate-spin h-8 w-8 text-green-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <p class="text-sm text-gray-600 mt-2">Decifrando seu documento... (Isso pode levar até 30s no primeiro uso)</p>
            </div>
            
            <div id="errorMessage" class="text-red-600 mt-4 text-sm p-3 bg-red-100 border border-red-400 rounded hidden"></div>

            <!-- Área de Resultados Estruturados -->
            <div id="resultDisplayContainer" class="mt-6 p-6 text-left hidden result-card">
                <h3 id="resultTitle" class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b"></h3>
                <div id="resultData" class="space-y-2"></div>
                <div class="mt-6 flex flex-wrap gap-4">
                    <button id="copyButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        Copiar Tudo
                    </button>
                    <button id="pdfButton" class="bg-red-500 text-white hover:bg-red-600 font-semibold py-2 px-4 rounded-lg flex items-center">
                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Exportar PDF
                    </button>
                    <button id="newFileButton" class="btn-primary-green font-semibold py-2 px-4 rounded-lg flex items-center ml-auto">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20v-5h5M20 4v5h-5"></path></svg>
                        Analisar Outro Documento
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Rodapé -->
    <footer class="py-6 px-4 sm:px-6 lg:px-8 w-full mt-auto">
        <div class="max-w-6xl mx-auto text-center sm:flex sm:justify-between sm:text-left">
            <div class="mb-2 sm:mb-0">
                <a href="mailto:iaextraia@gmail.com" class="text-sm text-gray-500 hover:text-gray-700 transition-colors">Contato</a>
            </div>
            <p class="text-sm text-gray-500">
                &copy; <span id="currentYear"></span> Extraia.ai
            </p>
        </div>
    </footer>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Elementos do DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const extractButton = document.getElementById('extractButton');
        const mainContent = document.getElementById('mainContent');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const resultDisplayContainer = document.getElementById('resultDisplayContainer');
        const resultTitle = document.getElementById('resultTitle');
        const resultDataEl = document.getElementById('resultData');
        const copyButton = document.getElementById('copyButton');
        const pdfButton = document.getElementById('pdfButton');
        const newFileButton = document.getElementById('newFileButton');

        let lastStructuredData = null;
        let lastFileName = '';
        
        // ***************************************************************
        // URL do Backend no Render.com JÁ CONFIGURADA
        // ***************************************************************
        const BACKEND_URL = 'https://extraiaia.onrender.com/api/extract';
        // ***************************************************************

        // --- Event Listeners ---
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            document.body.addEventListener(e, preventDefaults, false);
            uploadArea.addEventListener(e, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.add('bg-green-50', 'border-green-500'), false));
        ['dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.remove('bg-green-50', 'border-green-500'), false));
        uploadArea.addEventListener('drop', handleDrop, false);
        extractButton.addEventListener('click', callBackend);
        copyButton.addEventListener('click', copyResultsToClipboard);
        pdfButton.addEventListener('click', exportResultsToPdf);
        newFileButton.addEventListener('click', resetUI);

        // --- Funções ---
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) processFile(files[0]);
        }

        function handleDrop(event) {
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                processFile(files[0]);
            }
        }

        function processFile(file) {
            lastFileName = file.name;
            extractButton.disabled = false;
            extractButton.classList.remove('opacity-50', 'cursor-not-allowed');
            errorMessage.classList.add('hidden');
        }

        function resetUI() {
            mainContent.classList.remove('hidden');
            resultDisplayContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            fileInput.value = '';
            extractButton.disabled = true;
            extractButton.classList.add('opacity-50', 'cursor-not-allowed');
        }

        async function callBackend() {
            if (!fileInput.files || fileInput.files.length === 0) {
                showError('Por favor, selecione um arquivo primeiro.');
                return;
            }
            const file = fileInput.files[0];
            setLoadingState(true);

            const formData = new FormData();
            formData.append('document', file);

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.details || `Erro do servidor: ${response.status}`);
                }

                console.log("Backend respondeu:", result);
                lastStructuredData = result.structuredData;
                displayStructuredResults(result.structuredData, file.name);

            } catch (error) {
                console.error("Erro na chamada ao backend ou ao processar resposta:", error);
                showError(`Erro: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        function displayStructuredResults(data, fileName) {
            if (!data) {
                showError("A IA não conseguiu retornar dados estruturados do documento.");
                return;
            }
            mainContent.classList.add('hidden');
            resultTitle.textContent = `Informações Extraídas de "${fileName}"`;
            
            resultDataEl.innerHTML = '';

            const formatValue = (value) => {
                if (!value) return '<span class="text-gray-400">Não encontrado</span>';
                if (Array.isArray(value)) {
                    if (value.length === 0) return '<span class="text-gray-400">Não encontrado</span>';
                    return `<ul class="list-disc list-inside">${value.map(item => `<li>${item}</li>`).join('')}</ul>`;
                }
                return value;
            };
            
            const createItem = (label, value) => {
                if (value) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'result-item';
                    itemDiv.innerHTML = `<div class="result-label">${label}</div><div class="result-value">${formatValue(value)}</div>`;
                    resultDataEl.appendChild(itemDiv);
                }
            };
            
            createItem('Concurso/Vaga:', data.nomeConcursoOuVaga);
            createItem('Instituição:', data.instituicaoOrganizadora);
            createItem('Cargo(s):', data.principaisCargos);
            createItem('Salário Base:', data.salarioBase);
            createItem('Benefícios:', data.beneficios);
            createItem('Escolaridade:', data.escolaridadeExigida);
            if (data.periodoInscricao && (data.periodoInscricao.inicio || data.periodoInscricao.fim)) {
                createItem('Inscrições:', `${data.periodoInscricao.inicio || '?'} até ${data.periodoInscricao.fim || '?'}`);
            }
            createItem('Valor Inscrição:', data.valorInscricao);
            createItem('Data da Prova:', data.dataProva);
            createItem('Etapas:', data.principaisEtapas);
            
            resultDisplayContainer.classList.remove('hidden');
        }

        function copyResultsToClipboard() {
            if (!lastStructuredData) return;
            let textToCopy = `Informações Extraídas de "${lastFileName}" com Extraia.ai\n\n`;
            
            const appendToText = (label, value) => {
                if (value) {
                    if (Array.isArray(value)) {
                        textToCopy += `${label}: \n${value.map(item => `  - ${item}`).join('\n')}\n`;
                    } else {
                        textToCopy += `${label}: ${value}\n`;
                    }
                }
            };

            appendToText('Concurso/Vaga', lastStructuredData.nomeConcursoOuVaga);
            appendToText('Instituição', lastStructuredData.instituicaoOrganizadora);
            appendToText('Cargo(s)', lastStructuredData.principaisCargos);
            appendToText('Salário Base', lastStructuredData.salarioBase);
            appendToText('Benefícios', lastStructuredData.beneficios);
            appendToText('Escolaridade', lastStructuredData.escolaridadeExigida);
            if (lastStructuredData.periodoInscricao) {
                appendToText('Inscrições', `${lastStructuredData.periodoInscricao.inicio || '?'} até ${lastStructuredData.periodoInscricao.fim || '?'}`);
            }
            appendToText('Valor Inscrição', lastStructuredData.valorInscricao);
            appendToText('Data da Prova', lastStructuredData.dataProva);
            appendToText('Etapas', lastStructuredData.principaisEtapas);

            // Usando document.execCommand para compatibilidade, já que navigator.clipboard pode ser bloqueado em iframes.
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy.trim();
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Informações copiadas para a área de transferência!');
            } catch (err) {
                console.error('Falha ao copiar:', err);
                alert('Não foi possível copiar as informações.');
            }
            document.body.removeChild(textArea);
        }
        
        async function exportResultsToPdf() {
            if (!lastStructuredData) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            
            let y = 40; // Posição vertical inicial
            const leftMargin = 40;
            const rightMargin = doc.internal.pageSize.getWidth() - 40;

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text(`Resumo do Documento: "${lastFileName}"`, leftMargin, y);
            y += 25;
            doc.setFont('helvetica', 'normal');

            const addText = (label, value) => {
                if (value && y < 780) { // Verifica se há espaço na página
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${label}:`, leftMargin, y);
                    doc.setFont('helvetica', 'normal');

                    let valueText;
                    if (Array.isArray(value)) {
                        valueText = value.map(item => `- ${item}`).join('\n');
                    } else {
                        valueText = String(value);
                    }
                    const splitText = doc.splitTextToSize(valueText, rightMargin - leftMargin - 5); // 5 de margem extra
                    doc.text(splitText, leftMargin + 5, y + 15);
                    y += (splitText.length * 12) + 15;
                }
                 if (y > 780) { doc.addPage(); y = 40; }
            };
            
            addText('Concurso/Vaga', lastStructuredData.nomeConcursoOuVaga);
            addText('Instituição', lastStructuredData.instituicaoOrganizadora);
            addText('Cargo(s)', lastStructuredData.principaisCargos);
            addText('Salário Base', lastStructuredData.salarioBase);
            addText('Benefícios', lastStructuredData.beneficios);
            addText('Escolaridade', lastStructuredData.escolaridadeExigida);
            if (lastStructuredData.periodoInscricao) {
                 addText('Inscrições', `${lastStructuredData.periodoInscricao.inicio || '?'} até ${lastStructuredData.periodoInscricao.fim || '?'}`);
            }
            addText('Valor Inscrição', lastStructuredData.valorInscricao);
            addText('Data da Prova', lastStructuredData.dataProva);
            addText('Etapas', lastStructuredData.principaisEtapas);

            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Extraído com Extraia.ai - ${new Date().toLocaleDateString()}`, leftMargin, 820);
            
            doc.save(`resumo-${lastFileName.replace(/\.[^/.]+$/, "")}.pdf`);
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                mainContent.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            mainContent.classList.remove('hidden'); // Mostra a área de upload novamente
        }
    </script>
</body>
</html>
